<?xml version="1.0" encoding="UTF-8"?>
 
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
                  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">

    <changeSet id="20130204-true-false-concept-uuids" author="djazayeri">
        <comment>
            Setting the UUIDs for the automatically-generated 'true' and 'false' concepts to match those used by PIH broadly
        </comment>
        <update tableName="concept">
            <column name="uuid" value="3cd6f600-26fe-102b-80cb-0017a47871b2" />
            <where>concept_id = 1</where>
        </update>
        <update tableName="concept">
            <column name="uuid" value="3cd6f86c-26fe-102b-80cb-0017a47871b2" />
            <where>concept_id = 2</where>
        </update>
    </changeSet>

    <changeSet id="20140225-set-obs-datetime-to-encounter-datetime" author="djazayeri">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from global_property where property = 'mirebalais.UHM-1065.setObsDatetimeToEncounterDatetime'
            </sqlCheck>
        </preConditions>
        <comment>
            See UHM-1065.
            In our present information model, all Obs.obsDatetime should be equal to Obs.encounter.encounterDatetime,
            however due to a bug, 2/3 of obs are stored with the wrong datetime (though the vast majority are off by
            less than a day).
            This changeset is written so it gets run only one time, in case in the future we change our information
            model to include obs whose datatime is not equal to the encounter they are in (e.g. a form that captures
            multiple past lab results, each with its own date).
        </comment>
        <sql>
            update obs o, encounter e
            set o.obs_datetime = e.encounter_datetime
            where o.encounter_id = e.encounter_id
              and o.obs_datetime != e.encounter_datetime
        </sql>
    </changeSet>

    <changeSet id="20140408-delete-person-attributes-with-value-false" author="djazayeri">
        <comment>
            See UHM-1230: With UHM-1220 the code fix was made to correctly store phone numbers when entered as blank.
            Prior to that ticket, they were being stored as "false" in the database.
            In all of the environments (including production) there are several instances of them being false as a
            result of this bug. This changeset removes all person_attributes with value = false
        </comment>
        <delete tableName="person_attribute">
            <where>value='false'</where>
        </delete>
    </changeSet>
    
</databaseChangeLog>