<htmlform formUuid="ba22eda5-148d-456e-8adc-f36247d1f7c3" formName="Dispensing" formEncounterType="8ff50dea-18a1-4609-b4c9-3f8f2d611b84" formVersion="1.0" class="dispensing-form">
    <script type="text/javascript">
        var $j = jQuery;

        htmlForm.getBeforeValidation().push(function() {
            var numErrors = 0;
            var numDispensed = 0;
            $('fieldset.medication').each(function() {
                var numEmptyFields = 0;
                var numFilledFields = 0;
                $(this).find('input, select').each(function() {
                    if ($(this).val()) {
                        numFilledFields += 1;
                    } else {
                        numEmptyFields += 1;
                    }
                });
                if (numFilledFields > 0 &amp;&amp; numEmptyFields > 0) {
                    $(this).find('.field-error').first().html("All fields are required!").show();
                    numErrors += 1;
                } else {
                    $(this).find('.field-error').first().html("").hide();
                    if (numFilledFields > 0) {
                        numDispensed += 1;
                    }
                }
            });
            if (numErrors == 0 &amp;&amp; numDispensed == 0) {
                $('fieldset.medication').first().find('.field-error').first().html("Required").show();
            }
            return numErrors == 0 &amp;&amp; numDispensed > 0;
        });
    </script>

    <h2>Dispensing</h2>
    <table id="who-where-when-view">
        <tbody>
            <tr>
                <td>
                    <label>Dispensed by</label>
                    <span><encounterProviderAndRole default="currentUser" encounterRole="bad21515-fd04-4ff6-bfcd-78456d12f168" required="true"/></span>
                </td>
                <td>
                    <label><uimessage code="emr.location"/></label>
                    <span><encounterLocation default="SessionAttribute:emrContext.sessionLocationId"/></span>
                </td>
                <td>
                    <label><uimessage code="emr.patientDashBoard.date"/></label>
                    <span><encounterDate id="encounterDate" default="now" /></span>
                </td>
            </tr>
        </tbody>
    </table>

    <repeat with="['1'],['2'],['3'],['4'],['5']">
        <obsgroup groupingConceptId="PIH:9070">
            <h3>Medication {0}</h3>
            <fieldset class="medication">
                <p class="field-error" style="display:none"></p>
                <p>
                    <label>Name</label>
                    <obs class="medication-name" conceptId="PIH:1282" answerDrugs="true"/>
                </p>
                <p class="inline">
                    <label>Frequency</label>
                    <obs conceptId="PIH:3193"/>
                </p>
                <p class="inline">
                    <label>Dose</label>
                    <obs class="doseInput" conceptId="CIEL:160856"/>
                    <obs class="doseInput" conceptId="PIH:9074"/>
                </p>
                <p class="inline">
                    <label>Duration</label>
                    <obs class="doseInput" conceptId="CIEL:159368"/>
                    <obs class="select-arrow" conceptId="PIH:6412"/>
                </p>
                <p class="inline">
                    <label>Amount</label>
                    <obs conceptId="PIH:9071"/>
                </p>
            </fieldset>
        </obsgroup>
    </repeat>

    <p class="prescriber">
        <label>Prescriber (optional)</label>
        <span class="select-arrow"><encounterProviderAndRole encounterRole="c458d78e-8374-4767-ad58-9f8fe276e01c"/></span>
    </p>

    <ifMode mode="VIEW" include="false">
        <div id="buttons">
            <submit submitClass="confirm right" submitCode="mirebalais.save"/>
            <button type="button" class="cancel"><uimessage code="emr.cancel"/></button>
        </div>
    </ifMode>

</htmlform>