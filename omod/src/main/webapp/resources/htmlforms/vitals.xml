<!--
  ~ The contents of this file are subject to the OpenMRS Public License
  ~ Version 1.0 (the "License"); you may not use this file except in
  ~ compliance with the License. You may obtain a copy of the License at
  ~ http://license.openmrs.org
  ~
  ~ Software distributed under the License is distributed on an "AS IS"
  ~ basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See the
  ~ License for the specific language governing rights and limitations
  ~ under the License.
  ~
  ~ Copyright (C) OpenMRS, LLC.  All Rights Reserved.
  -->

<!-- TODO fix encounterRole-->
<htmlform formUuid="68728aa6-4985-11e2-8815-657001b58a90" formName="Vitals" formEncounterType="4fb47712-34a6-40d2-8ed3-e153abbd25b7" formVersion="1.0">
    <style>
        #calculated-bmi {
            font-weight: bold;
            font-size: 1.4em;
        }
    </style>

    <ifMode mode="ENTER">
        <script type="text/javascript">

            var fahrenheitErrorMessage = '<uimessage code="mirebalais.vitals.formValidaton.messages.onlyOneTemperature"/>';

            function FahrenheitFieldValidator() {};
            FahrenheitFieldValidator.prototype = new FieldValidator();
            FahrenheitFieldValidator.prototype.constructor = FahrenheitFieldValidator;
            FahrenheitFieldValidator.prototype.validate = function(fieldValue) {

                // first do basic numeric validation
                var numberValidationError= Validators['number'].validate(fieldValue);
                if (numberValidationError) {
                    return numberValidationError;
                }

                var numericRangeValidationError = Validators['numeric-range'].validate(fieldValue);
                if (numericRangeValidationError) {
                    return numericRangeValidationError;
                }

                // make sure user hasn't entered a value for both C and F
                if (getField('temperature_c.value').val() &amp;&amp; fieldValue &amp;&amp; fieldValue.value()) {
                    return fahrenheitErrorMessage;
                }
                else {
                    // convert F to C if necessary
                    if (fieldValue &amp;&amp; fieldValue.value()) {
                        setValue('temperature_c.value', convertFahrenheitToCelcius(fieldValue.value()));
                        $j('#temperature_f').val('');
                    }
                    return null;
                }
            }

            Validators['fahrenheit'] = new FahrenheitFieldValidator();

            var convertFahrenheitToCelcius = function(tempFahrenheit) {
                return ((tempFahrenheit - 32) * 5 / 9).toFixed(1);
            }

            var calculateBmi = function() {
                var wt = getValueIfLegal('weight.value');
                var ht = getValueIfLegal('height.value');
                var bmi = null
                if (wt &amp;&amp; ht) {
                    bmi = wt / (ht * ht);
                }
                if (bmi == null || isNaN(bmi)) {
                    $j('#no-calculated-bmi').show();
                    $j('#calculated-bmi-wrapper').hide();
                } else {
                    $j('#no-calculated-bmi').hide();
                    $j('#calculated-bmi-wrapper').show();
                    $j('#calculated-bmi').html(bmi.toFixed(1));
                    $j('#hidden-calculated-bmi').val(bmi.toFixed(1));
                }
            };

            $j(function() {
                $j('#calculated-bmi-wrapper').hide();

                getField('weight.value').change(calculateBmi);

                getField('height.value').change(calculateBmi);

                //$j('#confirmation .after-data-canvas').append('<img src="' + emr.resourceLink('mirebalais', 'images/triage/ke-vitals-placeholder.png') + '"/>');
            });
        </script>
    </ifMode>

    <div class="hidden" id="encounter-details" sectionTag="section" headerStyle="title" headerLabel="Encounter Details">
        <fieldset>
            <legend>When?</legend>
            <label>When?</label>

            <encounterDate default="now" showTime="true"/>
        </fieldset>

        <fieldset>
            <legend>Who?</legend>
            <label>Who?</label>

            <encounterProviderAndRole default="currentUser" encounterRole="a0b03050-c99b-11e0-9572-0800200c9a66" required="true"/>
        </fieldset>

        <fieldset>
            <legend>Where?</legend>
            <label>Where?</label>

            <encounterLocation default="SessionAttribute:emrContext.sessionLocationId"/>
        </fieldset>
    </div>

    <section id="vitals" sectionTag="section" headerStyle="title" headerLabel="Vitals">
        <fieldset>
            <legend><uimessage code="mirebalais.vitals.height.title"/></legend>
            <h3><uimessage code="mirebalais.vitals.height.title"/></h3>

            <p>
                <obs conceptId="PIH:HEIGHT (M)" id="height" showUnits="emr.units.meters" unitsCssClass="append-to-value"/>
            </p>
        </fieldset>

        <fieldset>
            <legend><uimessage code="mirebalais.vitals.weight.title"/></legend>
            <h3><uimessage code="mirebalais.vitals.weight.title"/></h3>

            <p>
                <obs conceptId="PIH:WEIGHT (KG)" id="weight" showUnits="emr.units.kilograms" unitsCssClass="append-to-value"/>
            </p>
        </fieldset>

        <!-- only show BMI if patient is more than 5 years old (on the encounterDate) -->
        <includeIf velocityTest="$patient.getAge($encounter.getEncounterDatetime()) > 5">

            <fieldset>
                <legend><uimessage code="mirebalais.vitals.bmi.title"/></legend>
                <h3><uimessage code="mirebalais.vitals.bmi.title"/></h3>

                <span id="no-calculated-bmi">
                    <uimessage code="mirebalais.vitals.bmi.instructions"/>
                </span>
                <span id="calculated-bmi-wrapper">
                    <uimessage code="mirebalais.vitals.bmi.display"/>
                    <span id='calculated-bmi'></span>
                </span>

                <p>
                    <input type="hidden" name="focus-in-bmi-question" id="hidden-calculated-bmi" />
                    <uimessage code="mirebalais.vitals.calculatedField.continue"/>
                </p>
            </fieldset>

        </includeIf>

        <fieldset>
            <legend><uimessage code="mirebalais.vitals.temperature.title"/></legend>
            <h3><uimessage code="mirebalais.vitals.temperature.title"/></h3>

            <p class="left">
                <obs conceptId="PIH:TEMPERATURE (C)" id="temperature_c" showUnits="emr.units.degreesCelsius" unitsCssClass="append-to-value"/>
            </p>

            <!-- if we are in one of the entry modes, display the field for entering temp in F -->
            <ifMode mode="ENTER">
                <p class="left">
                    <uimessage code="mirebalais.vitals.or"/>
                </p>
                <p class='left'>
                    <span class='obs-field'>
                        <input type="text" id="temperature_f" size="5" min="77.0" max="109" class="fahrenheit"/>
                        <span class="append-to-value"><uimessage code="mirebalais.vitals.degreesFahrenheit"/></span>
                        <span class="error field-error" style="display: none"></span>
                    </span>
                </p>
            </ifMode>

        </fieldset>

        <fieldset>
            <legend><uimessage code="mirebalais.vitals.heartRate.title"/></legend>
            <h3><uimessage code="mirebalais.vitals.heartRate.title"/></h3>

            <p>
                <obs conceptId="PIH:PULSE" id="heart_rate" showUnits="emr.units.perMinute" unitsCssClass="append-to-value"/>
            </p>
        </fieldset>

        <fieldset>
            <legend><uimessage code="mirebalais.vitals.respiratoryRate.title"/></legend>
            <h3><uimessage code="mirebalais.vitals.respiratoryRate.title"/></h3>

            <p>
                <obs conceptId="PIH:RESPIRATORY RATE" id="respiratory_rate" showUnits="emr.units.perMinute" unitsCssClass="append-to-value"/>
            </p>
        </fieldset>

        <fieldset field-separator=" / ">
            <legend><uimessage code="mirebalais.vitals.bloodPressure.title"/></legend>
            <h3><uimessage code="mirebalais.vitals.bloodPressure.title"/></h3>

            <p class="left">
                <obs conceptId="PIH:SYSTOLIC BLOOD PRESSURE" id="bp_systolic"/>
            </p>
            <p class="left">
                /
            </p>
            <p class="left">
                <obs conceptId="PIH:DIASTOLIC BLOOD PRESSURE" id="bp_diastolic"/>
            </p>
        </fieldset>

        <fieldset>
            <legend><uimessage code="mirebalais.vitals.o2sat.title"/></legend>
            <h3><uimessage code="mirebalais.vitals.o2sat.title"/></h3>

            <p>
                <obs conceptId="PIH:BLOOD OXYGEN SATURATION" id="o2_sat" showUnits="emr.units.percent" unitsCssClass="append-to-value"/>
            </p>
        </fieldset>

    </section>

    <submit/>

</htmlform>