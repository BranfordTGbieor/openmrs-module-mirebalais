<htmlform formUuid="793915d6-f8d9-11e2-8ff2-fd54ab5fdb2a" formName="ED Note" formEncounterType="92fd09b4-5335-4f7e-9f63-b2a663fd09a6" formVersion="1.0">

    <uiInclude provider="emr" javascript="angular.min.js"/>
    <uiInclude provider="emr" javascript="diagnoses/diagnoses.js"/>
    <uiInclude provider="emr" javascript="diagnoses/diagnoses-angular.js"/>

    <style type="text/css">
        #who-when-where {
            margin-bottom: 6px;
            border-bottom: 1px solid #ccc;
        }

        #who-when-where p {
            display: inline-block;
            padding-right: 20px;
        }

        #where > input[type=text] {
            display: inline-block;
        }

        .narrow {
            width: 200px;
        }

        .field-error {
            color: #ff6666;
            font-size: 1.1em;
            display: block;
        }

        #data-collection {
            display: inline-block;
            width: 58%;
            vertical-align: top;
        }

        #encounter-diagnoses-target {
            display: inline-block;
            width: 40%;
            vertical-align: top;
        }

        #encounter-diagnoses-app {
            margin-bottom: 20px;
        }

        <ifMode mode="EDIT">
            #disposition small {
                font-size: 100%;
                display: block;
            }

            #disposition span {
                padding-left: 15px;
            }
        </ifMode>
    </style>

    <ifMode mode="VIEW" include="false">
        <script type="text/javascript">


            var validateForm = function () {

                var needsDisposition;

                <excludeIf velocityTest="$user.hasPrivilege('Task: emr.retroConsultNote')">
                    needsDisposition = true
                </excludeIf>

                <includeIf velocityTest="$user.hasPrivilege('Task: emr.retroConsultNote')">
                    needsDisposition = false
                </includeIf>

                var hasDisposition = $('#disposition select:first').val() != '';

                var isValid =   $('#where select').val() != '' &amp;&amp;
                                $('#who select').val() != '' &amp;&amp;
                                $('#when input').val() != '' &amp;&amp;      // does this actually work?
                                $('.diagnosis').length &amp;&amp;
                                getValue("trauma.value") &amp;&amp;
                               (getValue("trauma.value") != yesCode || $('#trauma-type-container select').val() != '');

                var isScheduleFilled = ($('#apptDate input:last').val() != '' &amp;&amp; $('#service select').val() != '') ||
                                       ($('#apptDate input:last').val() == '' &amp;&amp; $('#service select').val() == '');

            console.log(isScheduleFilled);

                if (hasDisposition || needsDisposition) {
                    // make sure disposition and all related field have been filled out
                    isValid = isValid &amp;&amp; !$('#disposition select:visible').is(function() { return $(this).val() == ''; })  &amp;&amp;
                                                    !$('#disposition input:visible').is(function() { return $(this).val() == ''; })
                }

                if (isValid &amp;&amp; isScheduleFilled) {
                    $('.submitButton').removeAttr('disabled');
                    $('.submitButton').removeClass('disabled');
                }
                else {
                    $('.submitButton').attr('disabled', 'disabled');
                    $('.submitButton').addClass('disabled');
                }

            }

            var yesCode = <lookup expression="fn.getConcept('PIH:YES').id"/>;
            var traumaFieldName = null;

            radioClicked = function(radioButton) {
                // override this to do nothing -- we don't want to allow unselecting radio buttons here
            }

            var updateTraumaQuestions = function() {
                var trauma = getValue("trauma.value") == yesCode;
                console.log(getValue("trauma.value"));
                if (!trauma) {
                    getField("traumaType.value").val("");
                }
                $('#trauma-type-container').toggle(trauma);
            }

            // *super* hack to show/hide the boarding question based on whether or not the selected location is "ED Boarding"
            // (note that we test by text value which is really bad--but we have nothing else to access by at this point)
            var displayOrHideBoardingForQuestion = function () {

                if ($('#admissionLocation select option:selected').text() == 'ED Boarding' ||
                    $('#admissionLocation select option:selected').text() == 'Ijans Annatant') {
                    $('#boardingFor').parent().show();
                }
                else {
                    $('#boardingFor').parent().hide();
                    $('#boardingFor select').val('');
                }

            }

            $(function() {
                traumaFieldName = $('#trauma input[type=radio]').last().attr('name');
                //$('input[name=' + traumaFieldName + ']').change(updateTraumaQuestions);
                $('#trauma input').change(updateTraumaQuestions);
                updateTraumaQuestions();

                // hack to make this look like the entry form. need a better fix in HFE to make radio buttons look right
                $('#trauma input[type=radio]').last().appendTo('#no-goes-here');
                $('#trauma label').last().appendTo('#no-goes-here');
                $('#trauma span.required').hide();

                // yes, a rather large amount of events trigger a validation...
                $(document).change(validateForm);
                $(document).click(validateForm);

                $(document).change(displayOrHideBoardingForQuestion);

                displayOrHideBoardingForQuestion();
                validateForm();

            });
        </script>
    </ifMode>

    <ifMode mode="VIEW" include="false">
        <h2><uimessage code="emr.ed.consult.title"/></h2>

        <includeIf velocityTest="$user.hasPrivilege('Task: emr.retroConsultNote') || !($visit.open)">
            <div id="who-when-where">
                <p id="who">
                    <label><uimessage code="emr.patientDashBoard.provider"/></label>
                    <span><encounterProviderAndRole encounterRole="4f10ad1a-ec49-48df-98c7-1391c6ac7f05" required="true"/></span>
                </p>
                <p id="where">
                    <label><uimessage code="emr.location"/></label>
                    <span><encounterLocation tags="ED Note Location"/></span>
                </p>
                <p id="when">
                    <label><uimessage code="emr.patientDashBoard.date"/></label>
                    <span><encounterDate id="encounterDate" default="now" /></span>
                </p>
            </div>
        </includeIf>

        <excludeIf velocityTest="$user.hasPrivilege('Task: emr.retroConsultNote') || !($visit.open)">
            <div style="display:none">
                <encounterProviderAndRole default="currentUser" encounterRole="4f10ad1a-ec49-48df-98c7-1391c6ac7f05" required="true"/>
                <encounterLocation default="SessionAttribute:emrContext.sessionLocationId"/>
                <encounterDate id="encounterDate" default="now" />
            </div>


            <!-- hack to only show the provider, name and date when entering the form, since this displays the *current*
           user and location, not user and location stores on the form -->
            <ifMode mode="ENTER">
                <div id="who-when-where">
                    <table id="who-where-when-view"><tr>
                        <td>
                            <label><uimessage code="emr.patientDashBoard.provider"/></label>
                            <span><lookup expression="user.person.personName" /></span>
                        </td>
                        <td>
                            <label><uimessage code="emr.location"/></label>
                            <span><lookup complexExpression="$ui.format($sessionContext.sessionLocation)"/></span>
                        </td>
                        <td>
                            <label><uimessage code="emr.patientDashBoard.date"/></label>
                            <span><lookup complexExpression="$ui.format($fn.startOfDay($formGeneratedDatetime))"/></span>
                        </td>
                    </tr></table>
                </div>
            </ifMode>
        </excludeIf>

    </ifMode>

    <div id="data-collection">

        <encounterDiagnoses required="true" selectedDiagnosesTarget="#encounter-diagnoses-target"/>

        <div id="disposition">
            <encounterDisposition/>
        </div>

        <label><lookup expression="fn.getConcept('PIH:Occurrence of trauma').name"/> (<uimessage code="emr.formValidation.messages.requiredField.label"/>)</label>
        <p class="radio-btn">
            <obs id="trauma" conceptId="PIH:Occurrence of trauma" required="true" answerConceptIds="PIH:YES,PIH:NO" style="radio"/>
        </p>
        <p class="radio-btn" id="no-goes-here">
        </p>

        <p id="trauma-type-container">
            <label><lookup expression="fn.getConcept('PIH:Type of trauma').name"/></label>
            <obs id="traumaType" conceptId="PIH:Type of trauma" answerConceptIds="PIH:Transport Accident,SNOMED CT:397940009,PIH:Home accident,SNOMED CT:371772001,SNOMED CT:17542004,PIH:OTHER NON-CODED"/>
        </p>

        <excludeIf velocityTest="$featureToggles.isFeatureEnabled('scheduleAppointment')">
            <p class="narrow">
                <label><lookup expression="fn.getConcept('PIH:RETURN VISIT DATE').name"/></label>
                <obs conceptId="PIH:RETURN VISIT DATE" allowFutureDates="true"/>
            </p>
        </excludeIf>
        <includeIf velocityTest="$featureToggles.isFeatureEnabled('scheduleAppointment')">
            <div id="schedule-appointment">
                <fieldset> 
                   <legend>
                       <uimessage code="mirebalais.retrospectiveCheckin.scheduleAppointment" />
                   </legend>
                    <obsgroup groupingConceptId="PIH:Scheduled visit construct">
                        <p class="narrow date">
                            <label>
                                <uimessage code="mirebalais.retrospectiveCheckin.appointmentDate.label"/>
                            </label>
                            <obs conceptId="PIH:RETURN VISIT DATE" allowFutureDates="true" id="apptDate"/>
                        </p>

                        <p class="narrow select">
                            <label>
                                <uimessage code="mirebalais.retrospectiveCheckin.service.label"/>
                            </label>
                            <obs conceptId="PIH:Hospital service" id="service" showUnits="false"
                                 unitsCssClass="append-to-value" style="dropdown" size="1"/>
                        </p>
                    </obsgroup>
                </fieldset>
            </div>
        </includeIf>

        <p>
            <label><uimessage code="emr.consult.freeTextComments"/></label>
            <obs conceptId="org.openmrs.module.emr:Consult Free Text Comments" style="textarea" rows="5"/>
        </p>

    </div>

    <div id="encounter-diagnoses-target">
    </div>

    <ifMode mode="VIEW" include="false">
        <div id="buttons">
            <button class="submitButton confirm right disabled" onclick="submitHtmlForm()"><uimessage code="mirebalais.save"/><i class="icon-spinner icon-spin icon-2x" style="display: none; margin-left: 10px;"></i></button>
            <button type="button" class="cancel"><uimessage code="emr.cancel"/></button>
        </div>
    </ifMode>

</htmlform>