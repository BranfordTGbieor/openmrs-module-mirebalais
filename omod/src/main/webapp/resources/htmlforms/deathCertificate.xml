<htmlform class="simple-form-ui2" formUuid="c18d68ce-a130-4460-8cdf-6fbfaa33487e" formName="Death certificate"
          formEncounterType="1545d7ff-60f1-485e-9c95-5740b8e6634b" formVersion="2.0">

    <script type="text/javascript">
        window.messages = window.messages || { };
        window.messages['htmlformentry.general.days'] = '<uimessage code="htmlformentry.general.days"/>';
    </script>

    <translations defaultLocale="fr">
        <code name="death_certificate">
            <variant locale="en" value="Death certificate"/>
            <variant locale="fr" value="Certificat / Constat de deces"/>
        </code>
        <code name="death_details">
            <variant locale="en" value="Death Details"/>
            <variant locale="fr" value="Detailles du deces"/>
        </code>
        <code name="date_of_death">
            <variant locale="en" value="Date of Death"/>
            <variant locale="fr" value="Date de décès"/>
        </code>
        <code name="death_captured_by">
            <variant locale="en" value="Captured by"/>
            <variant locale="fr" value="TODO Captured by"/>
        </code>
        <code name="form_signed_by">
            <variant locale="en" value="Form Signed By"/>
            <variant locale="fr" value="TODO Form Signed By"/>
        </code>
        <code name="form_signed_role">
            <variant locale="en" value="Title"/>
            <variant locale="fr" value="TODO Title"/>
        </code>
        <code name="specify">
            <variant locale="en" value="Specify"/>
            <variant locale="fr" value="Préciser"/>
        </code>
        <code name="demographics">
            <variant locale="en" value="Demographics of deceased"/>
            <variant locale="fr" value="Caracteristiques du defunt"/>
        </code>
        <code name="location">
            <variant locale="en" value="Place of death"/>
            <variant locale="fr" value="Lieu du deces"/>
        </code>
        <code name="gender">
            <variant locale="en" value="Gender"/>
            <variant locale="fr" value="Sexe"/>
        </code>
        <code name="birthdate">
            <variant locale="en" value="Birthdate"/>
            <variant locale="fr" value="Date de naissance"/>
        </code>
        <code name="name">
            <variant locale="en" value="Name"/>
            <variant locale="fr" value="Nom"/>
        </code>
        <code name="address">
            <variant locale="en" value="Home address"/>
            <variant locale="fr" value="Résidence"/>
        </code>
        <code name="habitat">
            <variant locale="en" value="Environment"/>
            <variant locale="fr" value="Habitat"/>
        </code>
        <code name="civil_status">
            <variant locale="en" value="Marital status"/>
            <variant locale="fr" value="État matrimonial"/>
        </code>
        <code name="occupation">
            <variant locale="en" value="Occupation"/>
            <variant locale="fr" value="Occupation"/>
        </code>
        <code name="dossier">
            <variant locale="en" value="Dossier Number"/>
            <variant locale="fr" value="Dossier No"/>
        </code>
        <code name="provider">
            <variant locale="en" value="Provider"/>
            <variant locale="fr" value="Clinicien"/>
        </code>
        <code name="maternal_death">
            <variant locale="en" value="Maternal death"/>
            <variant locale="fr" value="Décès maternel"/>
        </code>
        <code name="if_external">
            <variant locale="en" value="If outside institution"/>
            <variant locale="fr" value="Si extra institutionnel"/>
        </code>
        <code name="if_internal">
            <variant locale="en" value="If within institution"/>
            <variant locale="fr" value="Si institutionnel"/>
        </code>
        <code name="service">
            <variant locale="en" value="Service"/>
            <variant locale="fr" value="Service"/>
        </code>
        <code name="location">
            <variant locale="en" value="Location"/>
            <variant locale="fr" value="Lieu"/>
        </code>
        <code name="days_in_hospital">
            <variant locale="en" value="Hospital stay (in days)"/>
            <variant locale="fr" value="Durée d'hospitalisation (en jours)"/>
        </code>
        <code name="doctor_visit_short">
            <variant locale="en" value="Received care"/>
            <variant locale="fr" value="Vu par un personnel de santé"/>
        </code>
        <code name="doctor_visit">
            <variant locale="en" value="Did the deceased visit health provider during this illness?"/>
            <variant locale="fr" value="Le défunt-a-t-il été vu par un personnel de santé au cours de cette maladie?"/>
        </code>
        <code name="yes_complete">
            <variant locale="en" value="If yes, complete certificate or report"/>
            <variant locale="fr" value="Si OUI, remplissez le certificat ou constat"/>
        </code>
        <code name="no_complete">
            <variant locale="en" value="If no, complete the circumstances section"/>
            <variant locale="fr" value="Si NON, remplissez la case ci-dessous"/>
        </code>
        <code name="info_source">
            <variant locale="en" value="Information source"/>
            <variant locale="fr" value="Source d'information"/>
        </code>
        <code name="circumstances">
            <variant locale="en" value="Circumstances of death"/>
            <variant locale="fr" value="Circonstances du décès"/>
        </code>
        <code name="clinical_exam">
            <variant locale="en" value="Clinical examination"/>
            <variant locale="fr" value="Examens paracliniques"/>
        </code>
        <code name="diagnosis_method">
            <variant locale="en" value="Method(s) to confirm diagnosis"/>
            <variant locale="fr" value="Moyen(s) de confirmation du diagnostic:"/>
        </code>
        <code name="diagnosis_method_short">
            <variant locale="en" value="Method(s)"/>
            <variant locale="fr" value="Moyen(s)"/>
        </code>
        <code name="certification_declaration">
            <variant locale="en" value="certified the death of the identified person"/>
            <variant locale="fr" value="certifie par la présente que la personne identifiée ci-dessus est décédée"/>
        </code>
        <code name="cause_of_death">
            <variant locale="en" value="Cause of death"/>
            <variant locale="fr" value="Cause du décès"/>
        </code>
        <code name="cause_of_death_instructions">
            <variant locale="en" value="Start with immediate cause, end with root cause"/>
            <variant locale="fr" value="TODO Start with immediate cause, end with root cause"/>
        </code>
        <code name="final_disease">
            <variant locale="en" value="Final disease or condition resulting in death"/>
            <variant locale="fr" value="Maladie ou ayant directement provoqué le décès"/>
        </code>
        <code name="due_to_or_following">
            <variant locale="en" value="caused by (or following)"/>
            <variant locale="fr" value="due à (ou consécutive à)"/>
        </code>
        <code name="condition_caused_final_disease">
            <variant locale="en" value="Condition which caused the previous disease or condition"/>
            <variant locale="fr" value="Affections morbides ayant éventuellement conduit a l'état préciser l'affectation initiale étant indiquée en dernier lieu"/>
        </code>
        <code name="contributing_condition_title">
            <variant locale="en" value="Contributing condition"/>
            <variant locale="fr" value="Autre état morbide"/>
        </code>
        <code name="contributing_condition">
            <variant locale="en" value="Condition contributing to the death but not related to the disease or morbid condition"/>
            <variant locale="fr" value="Autre état morbide important ayant contribué au décès mais sans rapport avec la maladie ou l'état morbide qui l'a provoqué"/>
        </code>
        <code name="burial_certificate">
            <variant locale="en" value="Burial certificate number"/>
            <variant locale="fr" value="Permis d'inhumer : N°"/>
        </code>
        <code name="icd_code">
            <variant locale="en" value="ICD-10 Code"/>
            <variant locale="fr" value="CODE CIM-10"/>
        </code>
        <code name="hour">
            <variant locale="en" value="Hour"/>
            <variant locale="fr" value="Heure"/>
        </code>
        <code name="minute">
            <variant locale="en" value="Minute"/>
            <variant locale="fr" value="Minute"/>
        </code>
        <code name="other">
            <variant locale="en" value="Other"/>
            <variant locale="fr" value="Autre"/>
        </code>
    </translations>

    <style class="text/css">
        @media print {
            div.patient-header {
                display: none;
            }
            body {
                font-size: 14px;
            }
        }

        /* the "required" class tells simple-form-entry UI to apply a validation, but it causes HFE to make the color red */
        .required.date-component {
            color: #003F5E; // $text from Mirebalais customVariables.scss
        }

        fieldset#institutional-view {
            float: left;
            width: 45%;
        }

        fieldset#extra-institutional-view {
            display: inline-block;
            width: 45%;
            vertical-align: top;
        }

        #permit {
            display: inline-block;
            width: 45%;
            margin-top: 20px;
            margin-left: 12px;
        }

        p.start-line {
            clear: left;
        }

        .one-quarter {
            display: inline-block;
            width: 22%;
            vertical-align: top;
        }

        .three-quarters {
            display: inline-block;
            width: 70%;
            vertical-align: top;
        }

        .one-third {
            display: inline-block;
            width: 30%;
            vertical-align: top;
        }

        .two-thirds {
            display: inline-block;
            width: 60%;
            vertical-align: top;
        }

        .one-half {
            display: inline-block;
            width: 46%;
            vertical-align: top;
        }

        .value {
            font-weight: bold;
            color: blue;
        }

        .spaced {
            margin-top: 10px;
            margin-bottom: 10px;
        }

        label {
            font-size: 0.8em;
        }

        h4#title {
            text-align: center;
            border-top: 1px #a0a0a0 solid;
            border-bottom: 1px #a0a0a0 solid;
        }

        .big-display {
            font-size: 1.5em;
        }

        .coded-or-free-text-title, .coded-or-free-text-between {
            font-size: 0.8em;
        }
    </style>

    <ifMode mode="VIEW">
        <lookup complexExpression="#set( $certificate = $fn.getObs($encounter, 'PIH: Visited provider during illness').valueCoded.equals($fn.getConcept('PIH: YES')) )"/>

        <h4 id="title">
            <small>MINISTERE DE LA SANTE PUBLIQUE ET DE LA POPULATION (MSPP)</small>
            <br/>
            CERTIFICAT / CONSTAT DE DECES
        </h4>

        <section sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="demographics">
            <p>
                <label><uimessage code="name"/></label>
                <lookup class="value" expression="patient.personName"/>
            </p>
            <p class="one-third">
                <label><uimessage code="gender"/></label>
                <lookup class="value" expression="patient.gender"/>
            </p>
            <p class="one-third">
                <label>Age</label>
                <lookup class="value" expression="patient.age"/>
            </p>
            <p class="one-third">
                <label><uimessage code="birthdate"/></label>
                <lookup class="value" complexExpression="#if( \$patient.birthdateEstimated ) ~#end"/> <lookup class="value" expression="patient.birthdate"/>
            </p>
            <p>
                <label><uimessage code="address"/></label>
                <lookup class="value" complexExpression="#foreach( $addr in $patient.addresses ) Départment: $!addr.stateProvince, Commune: $!addr.cityVillage &lt;br/&gt;#end"/>
            </p>
            <p class="one-quarter">
            </p>
            <p class="three-quarters">
                <label><uimessage code="habitat"/></label>
                <obs conceptId="PIH: Classification of residential environment"/>
            </p>
            <p class="one-third">
                <label><uimessage code="civil_status"/></label>
                <obs conceptId="PIH: CIVIL STATUS"/>
            </p>
            <p class="one-half">
                <label><uimessage code="occupation"/></label>
                <obs conceptId="PIH: MAIN ACTIVITY, NON-CODED"/>
            </p>
            <p class="one-quarter">
                <label><uimessage code="maternal_death"/></label>
                <obs conceptId="PIH: Maternal death"/>
            </p>
        </section>

        <section id="location" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="location">
            <p class="one-half">
                <includeIf velocityTest="$fn.getObs($encounter, 'PIH: Location of death').valueCoded.equals($fn.getConcept('PIH: Home')) || $fn.getObs($encounter, 'PIH: Location of death').valueCoded.equals($fn.getConcept('PIH: OTHER NON-CODED'))">
                    <span class="value">[X] <lookup expression="fn.getConcept('PIH: Outside of institution').name"/></span>
                </includeIf>
                <excludeIf velocityTest="$fn.getObs($encounter, 'PIH: Location of death').valueCoded.equals($fn.getConcept('PIH: Home')) || $fn.getObs($encounter, 'PIH: Location of death').valueCoded.equals($fn.getConcept('PIH: OTHER NON-CODED'))">
                    <span class="emptyValue">[&amp;nbsp;&amp;nbsp;] <lookup expression="fn.getConcept('PIH: Outside of institution').name"/></span>
                </excludeIf>
            </p>
            <p class="one-half">
                <obs id="institutional-death-span" conceptId="PIH: Location of death" answerConceptId="PIH: HOSPITAL"/>
            </p>
            <p class="one-quarter">
                <label><uimessage code="if_external"/></label>
            </p>
            <p class="three-quarters">
                <span class="one-third">
                    <obs conceptId="PIH: Location of death" answerConceptId="PIH: Home"/>
                </span>
                <span class="two-thirds">
                    <obs conceptId="PIH: Location of death" answerConceptId="PIH: OTHER NON-CODED"/>
                    <obs conceptId="PIH: Location of death non coded"/>
                </span>
            </p>
            <p class="one-quarter">
                <label><uimessage code="if_internal"/></label>
            </p>
            <p class="three-quarters">
                <span class="one-half">
                    Institution:
                    <includeIf velocityTest="$fn.getObs($encounter, 'PIH: Location of death').valueCoded.equals($fn.getConcept('PIH: HOSPITAL'))">
                        <span class="value">UHM</span>
                    </includeIf>
                </span>
                <span class="one-half">
                    <uimessage code="location"/>: <obs conceptId="PIH: Location of death at institution" style="location"/>
                </span>
            </p>
            <p class="two-thirds">
                <label><uimessage code="days_in_hospital"/></label>
                <obs conceptId="PIH: Duration of hospitalization when patient died"/>
            </p>
            <p class="one-third">
                <label><uimessage code="dossier"/></label>
                <lookup class="value" complexExpression="#foreach( $patId in $patientIdentifiers.get('Nimewo Dosye') ) $patId #end "/>
            </p>
        </section>

        <section id="care" sectionTag="div" headerTag="div" headerStyle="" headerCode="">
            <p class="spaced">
                <label><uimessage code="doctor_visit"/></label>
                <obs conceptId="PIH: Visited provider during illness"/><br/>
            </p>
        </section>

        <section id="institutional-view" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="death_certificate">
            <p>
                <label>Je soussigné</label>
                <includeIf velocityTest="$certificate">
                    <span class="value">
                        <encounterProviderAndRole encounterRole="4f10ad1a-ec49-48df-98c7-1391c6ac7f05"/>
                    </span>
                </includeIf>
            </p>
            <obsgroup groupingConceptId="PIH:9722">
            <p>
                <obs conceptId="PIH:TITLE WHO COMPLETED FORM" answerConceptIds="PIH:DOCTOR,PIH:NURSE,PIH:OTHER" style="radio"/>
                <obs conceptId="PIH:GENERAL FREE TEXT"/>
            </p>
            </obsgroup>
            <p>
                <label>
                    certifie par la présente que la personne identifiée ci-dessus est décédée le
                </label>
                <includeIf velocityTest="$certificate">
                    <encounterDate showTime="true"/>
                </includeIf>
            </p>

            <br/>
            <p>
                I. <causeOfDeathList/>
            </p>

            <br/>
            <p>
                II. <label><uimessage code="contributing_condition"/></label>
                <obs conceptId="PIH: Condition contributing to the death"
                     answerClasses="Diagnosis, Symptom" style="autocomplete"/>
            </p>

            <br/>
            <p>
                <label><uimessage code="diagnosis_method"/></label>
                <p>
                    <obs conceptId="PIH: Method of confirming death" answerConceptId="PIH: SURGERY"/>
                </p>
                <p>
                    <obs conceptId="PIH: Method of confirming death" answerConceptId="PIH: Autopsy"/>
                </p>
            </p>
        </section>

        <section id="extra-institutional-view" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="info_source">
            <p>
                <obs conceptId="PIH: Source of information" answerConceptId="PIH: OTHER FAMILY MEMBER"/>
            </p>
            <p>
                <obs conceptId="PIH: Source of information" answerConceptId="PIH: Police"/>
            </p>
            <p>
                <obs conceptId="PIH: Source of information" answerConceptId="PIH: Undertaker"/>
            </p>
            <p>
                <obs conceptId="PIH: Source of information" answerConceptId="PIH: OTHER NON-CODED"/>
            </p>
            <p>
                <br/>
                <label><uimessage code="circumstances"/></label>
                <br/>
                <obs conceptId="PIH: Circumstances of death" style="textarea" rows="4" cols="80"/>
            </p>
            <p>
                <excludeIf velocityTest="$certificate">
                    <br/>
                    <label><uimessage code="date_of_death"/></label>
                    <encounterDate showTime="true"/>
                </excludeIf>
            </p>
        </section>

        <section id="permit" sectionTag="div" headerTag="div">
            <p>
                <label><uimessage code="burial_certificate"/></label>
                <obs conceptId="PIH: Burial certificate" />
            </p>
            <p>
                <label><uimessage code="icd_code"/></label>
                <lookup class="value" complexExpression="#foreach($mapping in $patient.causeOfDeath.conceptMappings) #if($mapping.conceptReferenceTerm.conceptSource.name == 'ICD-10-WHO') $mapping.conceptReferenceTerm.code #end  #end"/>
            </p>
        </section>

        <div style="clear:both; height: 1px;"></div>
    </ifMode>

    <p style="display: none">
        <label><uimessage code="encounter_location"/></label>
        <encounterLocation default="SessionAttribute:emrContext.sessionLocationId"/>
    </p>

    <ifMode mode="VIEW" include="false">
        <script type="text/javascript">
            var encounterDateInput; // set in a script at the end of the page
            ExitHandlers['calc-enc-date'] = {
                handleExit: function(fieldModel) {
                    var date = $('.calc-enc-date.year').val() + '-' +
                        $('.calc-enc-date.month').val() + '-' +
                        leadingZero($('.calc-enc-date.day').val());
                    encounterDateInput.val(date);

                    $('#encounterDate .hfe-seconds').val(0);
                    if (Number($('.calc-enc-date.hour').val()) == 0) {
                        $('.calc-enc-date.hour').val('');
                        $('.calc-enc-date.minute').val('');
                        $('.calc-enc-date.ampm').val('AM');

                        $('#encounterDate .hfe-hours').val(hours);
                        $('#encounterDate .hfe-minutes').val(minutes);
                    }
                    else {
                        var hours = ($('.calc-enc-date.ampm').val() == 'PM' ? 12 : 0) +
                        Number($('.calc-enc-date.hour').val());
                        var minutes = $('.calc-enc-date.minute').val();

                        $('#encounterDate .hfe-hours').val(hours);
                        $('#encounterDate .hfe-minutes').val(minutes);
                    }
                    return true;
                }
            }

            function leadingZero(input) {
                return (input &lt; 10) ? ("0" + input) : input;
            }

            var defaultDeathDate = null;
            if ('<lookup expression="patient.deathDate"/>') {
                defaultDeathDate = new Date(<lookup expression="patient.deathDate.time"/>);
            }

            $(function() {
                // when you navigate to one of the date component field, select all its text
                // (might be nice to do this elsewhere also)
                $('.date-component').focus(function() {
                    $(this).select();
                });

                var demogConfirm = '<lookup expression="patient.personName.familyName"/>, ';
                demogConfirm += '<lookup expression="patient.personName.givenName"/>, ';
                demogConfirm += '<lookup expression="patient.gender"/>, ';
                demogConfirm += '<lookup complexExpression="#if( $patient.birthdateEstimated )~#end"/>';
                demogConfirm += '<lookup expression="patient.birthdate"/>';
                demogConfirm += '<lookup complexExpression="#foreach( $addr in $patient.addresses ) $!addr.stateProvince, $!addr.cityVillage &lt;br/&gt;#end"/>';
                $('#hidden-demog').val(demogConfirm);
            });
        </script>

        <section id="demographics" sectionTag="section" headerStyle="title" headerCode="demographics">

            <fieldset>
                <legend>Patient</legend>
                <p class="left">
                    <label>Nom</label>
                    <span class="big-display">
                        <lookup expression="patient.personName.familyName"/>
                    </span>
                </p>
                <p class="left">
                    <label>Prénom</label>
                    <span class="big-display">
                        <lookup expression="patient.personName.givenName"/>
                    </span>
                </p>
                <p style="clear: left" class="left">
                    <label>Sexe</label>
                    <span class="big-display">
                        <lookup expression="patient.gender"/>
                    </span>
                </p>
                <p class="left">
                    <label><uimessage code="birthdate"/></label>
                    <span class="big-display">
                        <lookup complexExpression="#if( $patient.birthdateEstimated ) ~ #end"/>
                        <lookup expression="patient.birthdate"/>
                    </span>
                </p>
                <p class="left">
                    <label>Age</label>
                    <span class="big-display">
                        <lookup expression="patient.age"/>
                    </span>
                </p>
                <p style="clear: left">
                    <label><uimessage code="address"/></label>
                    <span class="big-display">
                        <lookup complexExpression="#foreach( $addr in $patient.addresses ) Départment: $!addr.stateProvince, Commune: $!addr.cityVillage &lt;br/&gt;#end"/>
                    </span>
                </p>
                <p style="clear: left">
                    <label style="display: none">Name</label>
                    <br/>
                    <br/>
                    <uimessage code="mirebalais.vitals.calculatedField.continue"/>
                    <input type="hidden" id="hidden-demog"/>
                </p>
            </fieldset>

            <fieldset>
                <legend><uimessage code="habitat"/></legend>
                <p class="radio">
                    <label><uimessage code="habitat"/></label>
                    <obs conceptId="PIH: Classification of residential environment" size="2" answerConceptIds="PIH:Urban,PIH:Rural"/>
                </p>
            </fieldset>

            <fieldset>
                <legend><uimessage code="civil_status"/></legend>
                <p>
                    <label><uimessage code="civil_status"/></label>
                    <obs conceptId="PIH: CIVIL STATUS" size="7" answerConceptIds="PIH:SINGLE OR A CHILD,PIH:MARRIED,PIH:LIVING WITH PARTNER,PIH:SEPARATED,PIH:DIVORCED,PIH:WIDOWED"/>
                </p>
            </fieldset>

            <fieldset>
                <legend><uimessage code="occupation"/></legend>
                <p>
                    <label><uimessage code="occupation"/></label>
                    <obs conceptId="PIH: MAIN ACTIVITY, NON-CODED" size="60"/>
                </p>
            </fieldset>

            <fieldset>
                <legend><uimessage code="maternal_death"/></legend>
                <p>
                    <label><uimessage code="maternal_death"/></label>
                    <obs conceptId="PIH: Maternal death" size="2"/>
                </p>
            </fieldset>
        </section>

        <section id="death" sectionTag="section" headerStyle="title" headerCode="death_details">
            <fieldset display-template="{{field.[0]}}-{{field.[1]}}-{{field.[2]}} {{field.[3]}}:{{field.[4]}} {{field.[5]}}" class="calc-enc-date">
                <legend><uimessage code="date_of_death"/></legend>
                <h3><uimessage code="date_of_death"/></h3>

                <div style="display: none">
                    <encounterDate showTime="true" default="now"/>
                </div>

                <p class="required left" id="test-container">
                    <label><uimessage code="uicommons.multipleInputDate.day.label"/></label>
                    <input type="text" name="death-date-day" class="calc-enc-date day number numeric-range date-component required" min="1" max="31" maxLength="2" size="5"/>
                </p>
                <p class="required left">
                    <label><uimessage code="uicommons.multipleInputDate.month.label"/></label>
                    <select name="death-date-month" class="calc-enc-date month date-component required">
                        <option value=""></option>
                        <option value="01"><uimessage code="uicommons.month.1"/></option>
                        <option value="02"><uimessage code="uicommons.month.2"/></option>
                        <option value="03"><uimessage code="uicommons.month.3"/></option>
                        <option value="04"><uimessage code="uicommons.month.4"/></option>
                        <option value="05"><uimessage code="uicommons.month.5"/></option>
                        <option value="06"><uimessage code="uicommons.month.6"/></option>
                        <option value="07"><uimessage code="uicommons.month.7"/></option>
                        <option value="08"><uimessage code="uicommons.month.8"/></option>
                        <option value="09"><uimessage code="uicommons.month.9"/></option>
                        <option value="10"><uimessage code="uicommons.month.10"/></option>
                        <option value="11"><uimessage code="uicommons.month.11"/></option>
                        <option value="12"><uimessage code="uicommons.month.12"/></option>
                    </select>
                </p>
                <p class="required left">
                    <label><uimessage code="uicommons.multipleInputDate.year.label"/></label>
                    <input type="text" name="death-date-year" class="calc-enc-date year number date-component required" min="1900" max="2100" maxLength="4" size="5"/>
                </p>
                <p class="left" style="clear: left">
                    <label><uimessage code="hour"/></label>
                    <input type="text" name="death-date-hour" class="calc-enc-date hour number numeric-range date-component" min="1" max="12" maxLength="2" size="5"/>
                </p>
                <p class="left">
                    <label><uimessage code="minute"/></label>
                    <input type="text" name="death-date-minute" class="calc-enc-date minute number numeric-range date-component" min="0" max="59" maxLength="2" size="5"/>
                </p>
                <p class="left">
                    <label>AM/PM</label>
                    <select name="death-date-ampm" class="calc-enc-date ampm date-component" style="min-width: 0px">
                        <option value="AM">AM</option>
                        <option value="PM">PM</option>
                    </select>
                </p>
            </fieldset>

            <fieldset display-template="{{field.[0]}} ({{field.[1]}}{{#if field.[2]}}: {{field.[2]}}{{/if}})">
                <legend><uimessage code="death_captured_by"/></legend>

                <p>
                    <label><uimessage code="form_signed_by"/></label>
                    <encounterProviderAndRole default="currentUser" encounterRole="4f10ad1a-ec49-48df-98c7-1391c6ac7f05" required="true"/>
                </p>

                <obsgroup groupingConceptId="PIH:9722">
                    <p class="required">
                        <label><uimessage code="form_signed_role"/></label>
                        <obs id="form-signed-role" conceptId="PIH:TITLE WHO COMPLETED FORM" answerConceptIds="PIH:DOCTOR,PIH:NURSE,PIH:OTHER" size="3">
                            <controls>
                                <when value="PIH:OTHER"
                                      thenJavaScript="htmlForm.simpleUi.showField('form-signed-role-other')"
                                      elseJavaScript="htmlForm.simpleUi.hideField('form-signed-role-other')"/>
                            </controls>
                        </obs>
                    </p>
                    <p id="form-signed-role-other" class="left">
                        <label><uimessage code="specify"/></label>
                        <obs conceptId="PIH:GENERAL FREE TEXT"/>
                    </p>
                </obsgroup>
            </fieldset>
        </section>

        <section id="location" sectionTag="section" headerStyle="title" headerCode="location">
            <fieldset>
                <legend><uimessage code="location"/></legend>

                <p class="required">
                    <label><uimessage code="location"/></label>
                    <obs id="deathLocation" conceptId="PIH: Location of death" answerConceptIds="PIH: HOSPITAL,PIH: Home,PIH: OTHER NON-CODED" size="3">
                        <controls>
                            <when value="PIH: HOSPITAL"
                                  thenJavaScript="htmlForm.simpleUi.showQuestion('if-institutional')"
                                  elseJavaScript="htmlForm.simpleUi.hideQuestion('if-institutional')"/>
                            <when value="PIH: OTHER NON-CODED"
                                  thenJavaScript="htmlForm.simpleUi.showField('if-other')"
                                  elseJavaScript="htmlForm.simpleUi.hideField('if-other')"/>
                        </controls>
                    </obs>
                </p>
                <p id="if-other">
                    <label><uimessage code="specify"/></label>
                    <obs conceptId="PIH: Location of death non coded"/>
                </p>
            </fieldset>

            <fieldset id="if-institutional" display-template="{{field.[0]}}, {{field.[1]}} {{#unless field.[1]}}?{{/unless}} {{message 'htmlformentry.general.days'}}">
                <legend><uimessage code="if_internal"/></legend>
                <p>
                    <label><uimessage code="location"/></label>
                    <obs conceptId="PIH: Location of death at institution" style="location"/>
                </p>

                <p>
                    <label><uimessage code="days_in_hospital"/></label>
                    <obs conceptId="PIH: Duration of hospitalization when patient died"/>
                </p>
            </fieldset>
        </section>

        <section id="care" sectionTag="section" headerStyle="title" headerCode="doctor_visit_short">
            <fieldset>
                <legend><uimessage code="doctor_visit_short"/></legend>

                <p class="required">
                    <label><uimessage code="doctor_visit"/></label>
                    <obs id="seenByDoctor" conceptId="PIH: Visited provider during illness" style="dropdown" size="3">
                        <controls>
                            <when value="PIH: YES"
                                  thenJavaScript="htmlForm.simpleUi.showSection('certificat-constat')"
                                  elseJavaScript="htmlForm.simpleUi.hideSection('certificat-constat')"/>
                            <when value="PIH: NO"
                                  thenJavaScript="htmlForm.simpleUi.showSection('source-circumstances')"
                                  elseJavaScript="htmlForm.simpleUi.hideSection('source-circumstances')"/>
                        </controls>
                    </obs>
                </p>
            </fieldset>
        </section>

        <section id="certificat-constat" sectionTag="section" headerStyle="title" headerCode="death_certificate">
            <!-- TBD:  provider, signature, role, HUM department, date/time of death, patient died,
                address, telephone, printing, ICD10 code
            -->
            <fieldset>
                <legend><uimessage code="cause_of_death"/></legend>
                <causeOfDeathList/>
            </fieldset>
            <fieldset>
                <legend><uimessage code="contributing_condition_title"/></legend>
                <p>
                    <label><uimessage code="contributing_condition"/></label>
                    <obs conceptId="PIH: Condition contributing to the death"
                         answerClasses="Diagnosis, Symptom" style="autocomplete"/>
                </p>
            </fieldset>
            <fieldset>
                <legend><uimessage code="diagnosis_method_short"/></legend>
                <h3><uimessage code="diagnosis_method"/></h3>
                <p>
                    <obs conceptId="PIH: Method of confirming death" answerConceptId="PIH: SURGERY"/>
                </p>
                <p>
                    <obs conceptId="PIH: Method of confirming death" answerConceptId="PIH: Autopsy"/>
                </p>
            </fieldset>
        </section>

        <section id="source-circumstances" sectionTag="section" headerStyle="title" headerCode="info_source">
            <fieldset field-separator=", ">
                <legend><uimessage code="info_source"/></legend>
                <p>
                    <label><uimessage code="info_source"/></label>
                    <obs conceptId="PIH: Source of information" style="dropdown" size="5"
                         answerConceptIds="PIH: OTHER FAMILY MEMBER, PIH: Police, PIH: Undertaker, PIH: OTHER NON-CODED"/>
                </p>
                <p class="required">
                    <label><uimessage code="circumstances"/></label>
                    <obs conceptId="PIH: Circumstances of death" style="textarea" rows="4" cols="75"/>
                </p>
            </fieldset>
        </section>

        <section id="burial" sectionTag="section" headerStyle="title" headerCode="burial_certificate">
            <fieldset>
                <legend><uimessage code="burial_certificate"/></legend>
                <p>
                    <label><uimessage code="burial_certificate"/></label>
                    <obs conceptId="PIH: Burial certificate" />
                </p>
            </fieldset>
        </section>

        <markPatientDead/>

        <script type="text/javascript">
            // this code snippet is here (outside of a $(function) block) because we need it to happen before the navigator
            // model is built, and the date question does determineDisplayValue() the first time.

            encounterDateInput = $('#encounterDate input[type=hidden]');

            // set both the hidden inputs (from the encounterDate tag) and the custom visible inputs for this form
            if (defaultDeathDate) {
                // set date (y/m/d) fields
                var ymd = defaultDeathDate.toISOString();
                encounterDateInput.val(ymd.substring(0,10));
                $('.calc-enc-date.year').val(ymd.substring(0, 4));
                $('.calc-enc-date.month').val(ymd.substring(5, 7));
                $('.calc-enc-date.day').val(ymd.substring(8, 10));

                $('#encounterDate .hfe-hours').val('' + defaultDeathDate.getHours());
                var hour = defaultDeathDate.getHours();
                if (hour > 12) {
                    $('.calc-enc-date.hour').val(hour-12);
                    $('.calc-enc-date.ampm').val('PM');
                } else {
                    $('.calc-enc-date.hour').val(hour);
                    $('.calc-enc-date.ampm').val('AM');
                }

                $('#encounterDate .hfe-minutes').val('' + defaultDeathDate.getMinutes());
                $('.calc-enc-date.minute').val(leadingZero(defaultDeathDate.getMinutes()));
            } else {
                encounterDateInput.val('');
                $('#encounterDate .hfe-hours').val('');
                $('#encounterDate .hfe-minutes').val('');
                $('.calc-enc-date').val(''); // all visible inputs
            }
        </script>
    </ifMode>
</htmlform>